<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†çµ„è¨è«–å€ (å³æ™‚å”ä½œç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .btn { border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 5px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-red { background: #ff5252; color: white; }
        .btn-blue { background: #1976d2; color: white; }
        .btn-green { background: #4caf50; color: white; }
        .btn-gray { background: #ccc; color: #333; }

        /* ç™»å…¥é¸çµ„ç•«é¢ */
        .group-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .group-btn { padding: 20px; font-size: 1.2rem; border: none; border-radius: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; position: relative;}
        .group-btn:hover { background: #e3f2fd; transform: translateY(-2px); }
        .lock-icon { position: absolute; top: 10px; right: 10px; font-size: 1rem; color: #888; }
        
        /* å­¸ç”Ÿè¼¸å…¥ç•«é¢ */
        .student-view { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .group-badge { background: #1976d2; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: inline-block; margin-bottom: 20px;}
        
        /* å‹•æ…‹è¼¸å…¥è¡Œ */
        .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(-30px); }

        .input-row { display: flex; align-items: center; margin-bottom: 10px; }
        .row-bullet { font-size: 1.5rem; margin-right: 10px; color: #333; line-height: 1; }
        .row-input { flex: 1; padding: 12px; font-size: 1.1rem; border: 1px solid #ddd; border-radius: 5px; outline: none; transition: border 0.2s, background 0.3s; }
        .row-input:focus { border-color: #1976d2; background: #fff; }
        .row-input.updated { animation: highlight 1s ease; }

        @keyframes highlight { 0% { background: #e3f2fd; } 100% { background: #fff; } }
        
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; margin-left: 8px; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; transition: 0.2s; }
        .btn-del { background: #ffebee; color: #d32f2f; }
        .btn-del:hover { background: #d32f2f; color: white; }
        
        /* åº•éƒ¨æ–°å¢æŒ‰éˆ•å€ */
        .add-bar { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; text-align: center; }
        .btn-add-big { background: #e3f2fd; color: #1976d2; width: 100%; padding: 12px; border-radius: 8px; border: 2px dashed #90caf9; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add-big:hover { background: #bbdefb; border-color: #1976d2; }

        .status { text-align: right; color: #4caf50; font-size: 0.9rem; margin-top: 10px; height: 20px; }

        /* --- è€å¸«ç¸½è¦½ç•«é¢ä½ˆå±€è¨­å®š (æœ¬æ¬¡ä¿®æ”¹é‡é») --- */

        /* 1. é è¨­ä½ˆå±€ï¼š3 æ¬„ */
        /* é©ç”¨ï¼š5 çµ„ (3ä¸Š2ä¸‹), 6 çµ„ (3ä¸Š3ä¸‹), 9 çµ„ç­‰ */
        .teacher-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
        }

        /* 2. ç‰¹æ®Šä½ˆå±€ï¼š4 çµ„æ™‚å¼·åˆ¶ 2 æ¬„ (å‘ˆç¾ 2x2) */
        /* æ­¤ class é€é Vue ç¶å®šå‹•æ…‹åŠ å…¥ */
        .teacher-grid.layout-2cols {
            grid-template-columns: repeat(2, 1fr);
        }

        /* --- éŸ¿æ‡‰å¼æ–·é» (è™•ç†ç¸®æ”¾èˆ‡å°è¢å¹•) --- */

        /* 3. ä¸­å‹è¢å¹• (æˆ–ç€è¦½å™¨æ”¾å¤§) */
        /* ç•¶å¯¬åº¦å°æ–¼ 1024px æ™‚ï¼ŒåŸæœ¬ 3 æ¬„çš„æœƒè‡ªå‹•é™ç‚º 2 æ¬„ï¼Œé¿å…å¤ªæ“  */
        @media (max-width: 1024px) {
            .teacher-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
        }

        /* 4. å°å‹è¢å¹• (æ‰‹æ©Ÿ æˆ– ç€è¦½å™¨æ”¾å¤§å¾ˆå¤š) */
        /* å¼·åˆ¶è®Šæˆä¸€æ¬„å‘ä¸‹ï¼Œæ¬Šé‡æœ€é«˜ */
        @media (max-width: 768px) {
            .teacher-grid, 
            .teacher-grid.layout-2cols { 
                grid-template-columns: 1fr; 
            }
        }
        
        .group-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-height: 200px; }
        .group-card h3 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; color: #1976d2; display: flex; justify-content: space-between; align-items: center; }
        .group-content ul { padding-left: 20px; margin-top: 0; }
        .group-content li { margin-bottom: 5px; line-height: 1.5; word-break: break-all; }
        .empty-text { color: #999; font-style: italic; }
        
        /* æ§åˆ¶é … */
        .teacher-controls { text-align: center; margin-top: 40px; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; border-top: 1px dashed #ccc; padding-top: 20px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section h4 { margin: 0 0 10px 0; color: #555; }
        .modal-input-group { margin-bottom: 10px; display: flex; align-items: center; }
        .modal-input-group label { width: 80px; font-weight: bold; }
        .modal-input-group select, .modal-input-group input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;}
        .modal-actions { text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }

        .loading-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: #f0f2f5; display: flex; justify-content: center; align-items: center; z-index: 999; font-size: 1.5rem; color: #666; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="isLoading" class="loading-mask">è³‡æ–™è®€å–ä¸­...</div>

        <h1>{{ isTeacher ? 'è¬›å¸«ç¸½è¦½çœ‹æ¿' : (currentGroup ? 'åˆ†çµ„è¨è«–å€' : 'è«‹é¸æ“‡çµ„åˆ¥') }}</h1>

        <div v-if="!isTeacher && !currentGroup" class="group-selector-container">
            <div style="text-align: center; margin-bottom: 15px; color: #666;">
                <span v-if="hasPasswords">ğŸ”’ æœ¬æ¬¡è¨è«–è¨­æœ‰å¯†ç¢¼ä¿è­·ï¼Œè«‹é»æ“Šçµ„åˆ¥å¾Œè¼¸å…¥å¯†ç¢¼ã€‚</span>
                <span v-else>ç›®å‰ç„¡è¨­å®šå¯†ç¢¼ï¼Œè«‹ç›´æ¥é»æ“Šé€²å…¥ã€‚</span>
            </div>
            <div class="group-selector">
                <button v-for="i in groupCount" :key="i" class="group-btn" @click="tryEnterGroup(i)">
                    ç¬¬ {{ i }} çµ„
                    <span v-if="savedPasswords[i]" class="lock-icon">ğŸ”’</span>
                </button>
            </div>
        </div>

        <div v-if="!isTeacher && currentGroup" class="student-view">
            <div class="group-badge">æ‚¨ç¾åœ¨æ˜¯ï¼šç¬¬ {{ currentGroup }} çµ„</div>
            
            <div style="margin-bottom: 15px; color: #555;">
                å°çµ„æˆå“¡å¯ä»¥åŒæ™‚æ‰“å­—ï¼Œè³‡æ–™æœƒå³æ™‚åŒæ­¥åˆ°æ‰€æœ‰äººçš„ç•«é¢ä¸Šã€‚
            </div>

            <div class="dynamic-input-list">
                <transition-group name="list">
                    <div v-for="(item, index) in inputLines" :key="item.key" class="input-row">
                        <span class="row-bullet">â—</span>
                        
                        <input 
                            type="text" 
                            class="row-input"
                            v-model="item.text" 
                            placeholder="è¼¸å…¥æƒ³æ³•..."
                            @input="updateItem(item)"
                            @keydown.enter.prevent="addNewLine"
                        >
                        
                        <button class="icon-btn btn-del" @click="removeItem(item.key)" title="åˆªé™¤æ­¤è¡Œ" tabindex="-1">ğŸ—‘ï¸</button>
                    </div>
                </transition-group>
            </div>

            <div class="add-bar">
                <button class="btn-add-big" @click="addNewLine">ï¼‹ æ–°å¢ä¸‹ä¸€å€‹è«–é»</button>
            </div>

            <div class="status">{{ saveStatus }}</div>
        </div>

        <div v-if="isTeacher">
            <div class="teacher-grid" :class="{ 'layout-2cols': groupCount === 4 }">
                <div v-for="i in groupCount" :key="i" class="group-card">
                    <h3>
                        ç¬¬ {{ i }} çµ„ 
                        <span v-if="savedPasswords[i]" title="å·²å•Ÿç”¨å¯†ç¢¼ä¿è­·" style="font-size:1rem;">ğŸ”’</span>
                    </h3>
                    <div class="group-content">
                        <ul v-if="hasData(i)">
                            <li v-for="(line, k) in getGroupLines(i)" :key="k">
                                {{ line }}
                            </li>
                        </ul>
                        <p v-else class="empty-text">å°šç„¡å…§å®¹...</p>
                    </div>
                </div>
            </div>

            <div class="teacher-controls">
                <button class="btn btn-red" @click="resetAllData">ğŸ—‘ï¸ æ¸…ç©ºè¨è«–å…§å®¹</button>
                <button class="btn btn-blue" @click="openSettingsModal">âš™ï¸ ç³»çµ±è¨­å®š (çµ„æ•¸/å¯†ç¢¼)</button>
            </div>
        </div>

        <div v-if="showTeacherModal" class="modal-overlay" @click.self="showTeacherModal = false">
            <div class="modal-box">
                <div class="modal-title">ç³»çµ±è¨­å®š</div>
                <div class="modal-section">
                    <h4>1. è¨­å®šç¸½çµ„æ•¸ (1~10)</h4>
                    <div class="modal-input-group">
                        <label>çµ„æ•¸ï¼š</label>
                        <select v-model.number="tempGroupCount">
                            <option v-for="n in 10" :value="n">{{ n }} çµ„</option>
                        </select>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>2. è¨­å®šå„çµ„å¯†ç¢¼ (ç•™ç©ºå³ä¸è¨­é˜²)</h4>
                    <div v-for="i in tempGroupCount" :key="i" class="modal-input-group">
                        <label>ç¬¬ {{i}} çµ„</label>
                        <input type="text" v-model="tempPasswords[i]" placeholder="è¨­å®šå¯†ç¢¼...">
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-gray" @click="showTeacherModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-green" @click="saveSettings">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>

        <div v-if="showStudentLoginModal" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title">ğŸ”’ è«‹è¼¸å…¥ç¬¬ {{ attemptingGroup }} çµ„å¯†ç¢¼</div>
                <div class="modal-input-group">
                    <input type="text" v-model="studentInputPassword" placeholder="è«‹è©¢å•è¬›å¸«å¯†ç¢¼" style="font-size:1.2rem; text-align:center;">
                </div>
                <div style="text-align:center; color:red; margin-bottom:10px;">{{ loginError }}</div>
                <div class="modal-actions" style="text-align:center;">
                    <button class="btn btn-gray" @click="showStudentLoginModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-blue" @click="checkPassword">é€²å…¥è¨è«–</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, nextTick } = Vue;

        const firebaseConfig = {
            apiKey: "AIzaSyDUPGhkiJgxeYDYHqEaXCYvKh2vdTGqypw",
            authDomain: "class-discussion-01.firebaseapp.com",
            databaseURL: "https://class-discussion-01-default-rtdb.firebaseio.com",
            projectId: "class-discussion-01",
            storageBucket: "class-discussion-01.firebasestorage.app",
            messagingSenderId: "724687365020",
            appId: "1:724687365020:web:380b5d85872dc2d9b85e59",
            measurementId: "G-XYN5JV48T7"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        createApp({
            data() {
                return {
                    isLoading: true,
                    isTeacher: false,
                    currentGroup: null,
                    
                    // å­¸ç”Ÿç«¯è³‡æ–™
                    inputLines: [], 
                    
                    saveStatus: '',
                    allGroupsData: {},
                    typingTimer: null,
                    
                    groupCount: 6,
                    savedPasswords: {}, 
                    showTeacherModal: false,
                    tempPasswords: {},
                    tempGroupCount: 6,
                    showStudentLoginModal: false,
                    attemptingGroup: null,
                    studentInputPassword: '',
                    loginError: '',
                    pendingAutoGroup: null 
                }
            },
            computed: {
                hasPasswords() {
                    return Object.values(this.savedPasswords).some(p => p && p.trim() !== '');
                }
            },
            mounted() {
                const urlParams = new URLSearchParams(window.location.search);
                
                db.ref('settings').on('value', (snapshot) => {
                    const settings = snapshot.val() || {};
                    this.savedPasswords = settings.passwords || {};
                    this.groupCount = settings.groupCount || 6;
                    this.isLoading = false;
                    
                    if (this.pendingAutoGroup) {
                        if (this.pendingAutoGroup <= this.groupCount) {
                            this.tryEnterGroup(this.pendingAutoGroup);
                        }
                        this.pendingAutoGroup = null;
                    }
                });

                if (urlParams.get('role') === 'teacher') {
                    this.isTeacher = true;
                    this.listenToAllData();
                } else {
                    const groupParam = urlParams.get('group');
                    if (groupParam) {
                        this.pendingAutoGroup = parseInt(groupParam);
                    }
                }
            },
            methods: {
                // --- å­¸ç”ŸåŠŸèƒ½ ---
                tryEnterGroup(num) {
                    this.attemptingGroup = num;
                    const requiredPwd = this.savedPasswords[num];
                    
                    if (requiredPwd && requiredPwd.trim() !== '') {
                        this.studentInputPassword = '';
                        this.loginError = '';
                        this.showStudentLoginModal = true;
                    } else {
                        this.enterGroup(num);
                    }
                },
                checkPassword() {
                    if (this.studentInputPassword === this.savedPasswords[this.attemptingGroup]) {
                        this.showStudentLoginModal = false;
                        this.enterGroup(this.attemptingGroup);
                    } else {
                        this.loginError = 'å¯†ç¢¼éŒ¯èª¤';
                    }
                },
                enterGroup(num) {
                    this.currentGroup = num;
                    this.isLoading = true;

                    db.ref('groups/group_' + num).on('value', (snapshot) => {
                        const val = snapshot.val();
                        this.isLoading = false;

                        if (!val) {
                            if (this.inputLines.length === 0) {
                                this.addNewLine(); 
                            } else {
                                this.inputLines = [];
                                this.addNewLine();
                            }
                            return;
                        }

                        if (typeof val === 'string') {
                            this.inputLines = [{key: 'legacy', text: val}];
                        } else {
                            const newList = [];
                            snapshot.forEach(childSnapshot => {
                                newList.push({
                                    key: childSnapshot.key,
                                    text: childSnapshot.val()
                                });
                            });
                            this.inputLines = newList;
                        }
                    });
                },
                
                updateItem(item) {
                    this.saveStatus = 'åŒæ­¥ä¸­...';
                    db.ref('groups/group_' + this.currentGroup + '/' + item.key).set(item.text)
                        .then(() => { this.saveStatus = 'å·²åŒæ­¥'; })
                        .catch(() => { this.saveStatus = 'åŒæ­¥å¤±æ•—'; });
                },

                addNewLine() {
                    db.ref('groups/group_' + this.currentGroup).push('').then(() => {
                        this.saveStatus = 'å·²æ–°å¢';
                    });
                },
                
                removeItem(key) {
                    db.ref('groups/group_' + this.currentGroup + '/' + key).remove();
                },

                // --- è€å¸«åŠŸèƒ½ ---
                listenToAllData() {
                    db.ref('groups').on('value', (snapshot) => {
                        this.allGroupsData = snapshot.val() || {};
                    });
                },
                hasData(groupIndex) {
                    const data = this.allGroupsData['group_' + groupIndex];
                    return data && (typeof data === 'string' || Object.keys(data).length > 0);
                },
                getGroupLines(groupIndex) {
                    const data = this.allGroupsData['group_' + groupIndex];
                    if (!data) return [];
                    
                    if (typeof data === 'string') {
                        return data.split('\n').filter(l => l.trim() !== '');
                    } else {
                        return Object.values(data).filter(l => l && l.trim() !== '');
                    }
                },
                resetAllData() {
                    if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ\n(é€™æœƒé‡ç½®è³‡æ–™çµæ§‹ï¼Œå»ºè­°åŸ·è¡Œä»¥ç¢ºä¿å”ä½œé †æš¢)')) {
                        db.ref('groups').set(null);
                        this.allGroupsData = {};
                    }
                },
                
                // --- ç³»çµ±è¨­å®š ---
                openSettingsModal() {
                    this.tempPasswords = { ...this.savedPasswords };
                    this.tempGroupCount = this.groupCount;
                    this.showTeacherModal = true;
                },
                saveSettings() {
                    db.ref('settings').update({
                        passwords: this.tempPasswords,
                        groupCount: this.tempGroupCount
                    }).then(() => {
                        this.showTeacherModal = false;
                        alert('ç³»çµ±è¨­å®šå·²æ›´æ–°ï¼');
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
